<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HourSnake Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #1a1a1a;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    #game-container {
      position: relative;
      width: 400px;
      height: 400px;
      margin: 20px;
    }

    #game-canvas {
      border: 2px solid #4CAF50;
      background: #000;
    }

    /* Simple spacing and centering for status elements */
    #leaderboard,
    #countdown {
      margin: 10px 0;
      text-align: center;
    }

    button {
      background: #4CAF50;
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    button:hover {
      background: #45a049;
    }

    #game-over {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Snake Game</h1>

  <!-- Pay 1 Star to start playing -->
  <button id="play-button" onclick="payAndStartGame()">Pay 1 Star to Play</button>

  <!-- Countdown to the next hour (awards time) -->
  <div id="countdown">Next rewards in: Loading...</div>

  <!-- Current hour’s top 10 scoreboard -->
  <div id="leaderboard">Leaderboard: Loading...</div>

  <!-- Main game container with a canvas and “game over” overlay -->
  <div id="game-container">
    <canvas id="game-canvas" width="400" height="400"></canvas>
    <div id="game-over">
      <h2>Game Over!</h2>
      <p>Your score: <span id="final-score">0</span></p>
      <button onclick="restartGame()">Play Again</button>
    </div>
  </div>

  <script>
    const backendUrl = "https://hoursnake.onrender.com"; // Adjust if needed
    let telegramUserId;

    // ----------------------------
    // 1. Initialize on page load
    // ----------------------------
    window.onload = function () {
      // Initialize Telegram WebApp
      try {
        const telegram = Telegram.WebApp;
        telegramUserId = telegram.initDataUnsafe?.user?.id;
        if (!telegramUserId) {
          alert("Unable to fetch Telegram User ID. Please ensure you're accessing the game from Telegram.");
        } else {
          console.log("Telegram User ID:", telegramUserId);
        }
      } catch (error) {
        console.error("Error initializing Telegram WebApp:", error);
        alert("Failed to initialize Telegram WebApp. Ensure you're running this through Telegram.");
      }

      // Start intervals for countdown and leaderboard updates
      setInterval(updateCountdown, 1000);         // update countdown every second
      setInterval(fetchCurrentLeaderboard, 10000); // update leaderboard every 10 seconds

      // Initial fetch of leaderboard
      fetchCurrentLeaderboard();
    };

    // ----------------------------
    // 2. Pay 1 Star, then Start Game
    // ----------------------------
    async function payAndStartGame() {
      try {
        // 1) Request an invoice link from our backend
        const resp = await fetch(`${backendUrl}/create-invoice`, {
          method: "POST"
        });
        const data = await resp.json();
        if (!data.invoiceLink) {
          alert("Error retrieving invoice link");
          return;
        }

        // 2) Open the invoice link with Telegram’s official star payment
        Telegram.WebApp.openInvoice(data.invoiceLink, (status) => {
          // status can be "paid", "cancelled", "failed", "pending"
          if (status === "paid") {
            alert("Payment successful! Starting game...");
            // Disable the button until the game ends
            document.getElementById("play-button").disabled = true;
            // Start the snake game
            startGame();
          } else {
            alert("Payment not completed: " + status);
          }
        });
      } catch (error) {
        console.error("Error creating or opening invoice:", error);
        alert("Could not open invoice!");
      }
    }

    // ----------------------------
    // 3. Real-Time Countdown
    // ----------------------------
    function updateCountdown() {
      const now = Date.now();
      // Next hour boundary
      const nextHour = now - (now % 3600000) + 3600000;
      const diffMs = nextHour - now;
      const minutes = Math.floor(diffMs / 60000);
      const seconds = Math.floor((diffMs % 60000) / 1000);

      document.getElementById('countdown').innerText =
        `Next rewards in: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    // ----------------------------
    // 4. Leaderboard (Current Hour)
    // ----------------------------
    async function fetchCurrentLeaderboard() {
      try {
        const response = await fetch(`${backendUrl}/current-leaderboard`);
        const data = await response.json();
        if (data.success) {
          let leaderboardHTML = '<h3>Current Hour Leaderboard</h3>';
          data.leaderboard.forEach((entry, index) => {
            leaderboardHTML += `<p>${index + 1}. ${entry.username || 'Anonymous'} - ${entry.score}</p>`;
          });
          document.getElementById("leaderboard").innerHTML = leaderboardHTML;
        } else {
          document.getElementById("leaderboard").innerHTML = "Error loading leaderboard.";
        }
      } catch (error) {
        console.error("Error fetching current-hour leaderboard:", error);
        document.getElementById("leaderboard").innerHTML = "Leaderboard: Error";
      }
    }

    // ----------------------------
    // 5. Snake Game Logic
    // ----------------------------
    let gameInterval; // keep a reference for clearing

    function startGame() {
      const canvas = document.getElementById("game-canvas");
      const ctx = canvas.getContext("2d");

      let snake = [{ x: 10, y: 10 }];
      let food = { x: 15, y: 15 };
      let dx = 1, dy = 0;
      let score = 0;

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw snake
        snake.forEach(segment => {
          ctx.fillStyle = "lime";
          ctx.fillRect(segment.x * 20, segment.y * 20, 20, 20);
        });

        // Draw food
        ctx.fillStyle = "red";
        ctx.fillRect(food.x * 20, food.y * 20, 20, 20);
      }

      function update() {
        const head = { x: snake[0].x + dx, y: snake[0].y + dy };

        // Check if we ate the food
        if (head.x === food.x && head.y === food.y) {
          score++;
          food = {
            x: Math.floor(Math.random() * 20),
            y: Math.floor(Math.random() * 20)
          };
        } else {
          // Remove the tail
          snake.pop();
        }
        snake.unshift(head);

        // Check collision with walls or self
        if (
          head.x < 0 || head.y < 0 ||
          head.x >= 20 || head.y >= 20 ||
          snake.slice(1).some(segment => segment.x === head.x && segment.y === head.y)
        ) {
          endGame(score);
        }
      }

      function endGame(finalScore) {
        clearInterval(gameInterval);
        document.getElementById("final-score").innerText = finalScore;
        document.getElementById("game-over").style.display = "block";

        // Re-enable the "Pay" button so they can pay again if they want a new run
        document.getElementById("play-button").disabled = false;

        // Optionally submit final score to server
        // If you still want a scoreboard logic with "submit-score" route
        if (telegramUserId && typeof finalScore === 'number') {
          fetch(`${backendUrl}/game/submit-score`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              telegram_id: telegramUserId,
              score: finalScore
            })
          })
          .then(res => res.json())
          .then(data => {
            console.log('Score submission response:', data);
            // Optionally refresh leaderboard
            fetchCurrentLeaderboard();
          })
          .catch(err => console.error('Error submitting score:', err));
        }
      }

      function restartGame() {
        // Hide Game Over overlay
        document.getElementById("game-over").style.display = "none";
        clearInterval(gameInterval);

        // If you want them to pay again each time, call payAndStartGame();
        // Or let them freely restart as many times as they want in one paid session.
        snake = [{ x: 10, y: 10 }];
        food = { x: 15, y: 15 };
        dx = 1; dy = 0;
        score = 0;

        gameInterval = setInterval(() => {
          update();
          draw();
        }, 200);
      }

      // Key controls
      document.addEventListener("keydown", event => {
        if (event.key === "ArrowUp" && dy === 0)    { dx = 0; dy = -1; }
        if (event.key === "ArrowDown" && dy === 0)  { dx = 0; dy = 1; }
        if (event.key === "ArrowLeft" && dx === 0)  { dx = -1; dy = 0; }
        if (event.key === "ArrowRight" && dx === 0) { dx = 1; dy = 0; }
      });

      // Start the main game loop
      gameInterval = setInterval(() => {
        update();
        draw();
      }, 200);
    }

    // Expose restartGame globally so we can call it from the "Play Again" button
    window.restartGame = function() {
      restartGame();
    };
  </script>
</body>
</html>
